/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package gpsdistancegrab;

import java.util.Date;
import java.text.DateFormat;
import java.text.SimpleDateFormat;
import javax.swing.JFileChooser;
import java.util.Vector;
import java.text.DecimalFormat;
import java.io.*;

/**
 *
 * @author simon
 */
public class MainForm extends javax.swing.JFrame {

    /**
     * Creates new form MainForm
     */
    public MainForm() {
        initComponents();
        
        //new setup code added by simon
        DateField.setValue(new Date());
        StartTimeField.setValue(new Date());
        EndTimeField.setValue(new Date());
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        FileLoadPanel = new javax.swing.JPanel();
        FileNameField = new javax.swing.JFormattedTextField();
        BrowseFileButton = new javax.swing.JButton();
        jLabel4 = new javax.swing.JLabel();
        DateTimePanel = new javax.swing.JPanel();
        DateField = new javax.swing.JFormattedTextField(new SimpleDateFormat("dd-MM-yyyy"));
        StartTimeField = new javax.swing.JFormattedTextField(new SimpleDateFormat("HH:mm:ss"));
        EndTimeField = new javax.swing.JFormattedTextField(new SimpleDateFormat("HH:mm:ss"));
        jLabel1 = new javax.swing.JLabel();
        jLabel2 = new javax.swing.JLabel();
        jLabel3 = new javax.swing.JLabel();
        jPanel1 = new javax.swing.JPanel();
        RunButton = new javax.swing.JButton();
        OutputScrollPane = new javax.swing.JScrollPane();
        OutputTextArea = new javax.swing.JTextArea();
        jLabel5 = new javax.swing.JLabel();

        setDefaultCloseOperation(javax.swing.WindowConstants.EXIT_ON_CLOSE);
        setTitle("TRG gps Scraper v 1.0");

        BrowseFileButton.setText("Browse");
        BrowseFileButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                BrowseFileButtonActionPerformed(evt);
            }
        });

        jLabel4.setText("Enter the path to the folder containing .gpx files");

        javax.swing.GroupLayout FileLoadPanelLayout = new javax.swing.GroupLayout(FileLoadPanel);
        FileLoadPanel.setLayout(FileLoadPanelLayout);
        FileLoadPanelLayout.setHorizontalGroup(
            FileLoadPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(FileLoadPanelLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(FileLoadPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(FileLoadPanelLayout.createSequentialGroup()
                        .addComponent(FileNameField, javax.swing.GroupLayout.PREFERRED_SIZE, 341, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(18, 18, 18)
                        .addComponent(BrowseFileButton))
                    .addComponent(jLabel4))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );
        FileLoadPanelLayout.setVerticalGroup(
            FileLoadPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(FileLoadPanelLayout.createSequentialGroup()
                .addComponent(jLabel4)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 17, Short.MAX_VALUE)
                .addGroup(FileLoadPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(FileNameField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(BrowseFileButton))
                .addContainerGap())
        );

        DateField.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                DateFieldActionPerformed(evt);
            }
        });

        jLabel1.setText("Enter DATE of test using \"dd-mm-yyy\" format");

        jLabel2.setText("Enter START TIME of test using \"hh:mm:ss\" format");

        jLabel3.setText("Enter END TIME of test using \"hh:mm:ss\" format");

        RunButton.setText("Run Program");
        RunButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                RunButtonActionPerformed(evt);
            }
        });

        OutputTextArea.setColumns(20);
        OutputTextArea.setRows(5);
        OutputScrollPane.setViewportView(OutputTextArea);

        jLabel5.setText("Output Messages");

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addContainerGap()
                        .addComponent(OutputScrollPane))
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addGroup(jPanel1Layout.createSequentialGroup()
                                .addGap(185, 185, 185)
                                .addComponent(RunButton))
                            .addGroup(jPanel1Layout.createSequentialGroup()
                                .addContainerGap()
                                .addComponent(jLabel5)))
                        .addGap(0, 0, Short.MAX_VALUE)))
                .addContainerGap())
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(RunButton)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 14, Short.MAX_VALUE)
                .addComponent(jLabel5)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(OutputScrollPane, javax.swing.GroupLayout.PREFERRED_SIZE, 172, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap())
        );

        javax.swing.GroupLayout DateTimePanelLayout = new javax.swing.GroupLayout(DateTimePanel);
        DateTimePanel.setLayout(DateTimePanelLayout);
        DateTimePanelLayout.setHorizontalGroup(
            DateTimePanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(DateTimePanelLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(DateTimePanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(DateTimePanelLayout.createSequentialGroup()
                        .addGroup(DateTimePanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING, false)
                            .addComponent(StartTimeField, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.DEFAULT_SIZE, 118, Short.MAX_VALUE)
                            .addComponent(DateField, javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(EndTimeField))
                        .addGap(18, 18, 18)
                        .addGroup(DateTimePanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(jLabel1)
                            .addComponent(jLabel2)
                            .addComponent(jLabel3))
                        .addContainerGap())
                    .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)))
        );
        DateTimePanelLayout.setVerticalGroup(
            DateTimePanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(DateTimePanelLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(DateTimePanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(DateField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jLabel1))
                .addGap(18, 18, 18)
                .addGroup(DateTimePanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(StartTimeField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jLabel2))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(DateTimePanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(EndTimeField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jLabel3))
                .addGap(18, 18, 18)
                .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(FileLoadPanel, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(DateTimePanel, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addContainerGap(56, Short.MAX_VALUE))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGap(28, 28, 28)
                .addComponent(FileLoadPanel, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(27, 27, 27)
                .addComponent(DateTimePanel, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addGap(44, 44, 44))
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void DateFieldActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_DateFieldActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_DateFieldActionPerformed

    private void RunButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_RunButtonActionPerformed
        // TODO add your handling code here:
        ScrapeAway TheScraper = new ScrapeAway(FileNameField.getText(),DateField.getText(),StartTimeField.getText(),EndTimeField.getText());
        Vector<JourneyStats> Statistics = TheScraper.ListGPXdata();
        
        OutputRunStatistics(Statistics);
    }//GEN-LAST:event_RunButtonActionPerformed

    private void BrowseFileButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_BrowseFileButtonActionPerformed
        // TODO add your handling code here:
        JFileChooser fc = new JFileChooser();
        fc.setFileSelectionMode(JFileChooser.DIRECTORIES_ONLY);
        int RetVal =fc.showOpenDialog(null);
        
        if(RetVal == fc.APPROVE_OPTION)
        {
            String Filename = fc.getSelectedFile().getPath();
            FileNameField.setText(Filename);
            //OutputTextArea.append(Filename + '\n');
        }
    }//GEN-LAST:event_BrowseFileButtonActionPerformed

    /**
     * @param args the command line arguments
     */
    public static void main(String args[]) {
        /*
         * Set the Nimbus look and feel
         */
        //<editor-fold defaultstate="collapsed" desc=" Look and feel setting code (optional) ">
        /*
         * If Nimbus (introduced in Java SE 6) is not available, stay with the
         * default look and feel. For details see
         * http://download.oracle.com/javase/tutorial/uiswing/lookandfeel/plaf.html
         */
        try {
            for (javax.swing.UIManager.LookAndFeelInfo info : javax.swing.UIManager.getInstalledLookAndFeels()) {
                if ("Nimbus".equals(info.getName())) {
                    javax.swing.UIManager.setLookAndFeel(info.getClassName());
                    break;
                }
            }
        } catch (ClassNotFoundException ex) {
            java.util.logging.Logger.getLogger(MainForm.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (InstantiationException ex) {
            java.util.logging.Logger.getLogger(MainForm.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (IllegalAccessException ex) {
            java.util.logging.Logger.getLogger(MainForm.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (javax.swing.UnsupportedLookAndFeelException ex) {
            java.util.logging.Logger.getLogger(MainForm.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        }
        //</editor-fold>

        /*
         * Create and display the form
         */
        java.awt.EventQueue.invokeLater(new Runnable() {

            public void run() {
                new MainForm().setVisible(true);
            }
        });
        
        
    }
    
    private void OutputRunStatistics(Vector<JourneyStats> TheStats)
    {
        double TotalDistance = 0;
        double AverageDistance;
        double AverageSpeed1 = 0;
        double AverageSpeed2 = 0;
        double TotalTime = 0;
        double AverageTime = 0;
        
        int N = TheStats.size();
        
        for(JourneyStats st : TheStats)
        {
            TotalDistance += st.DistanceTravelled;
            AverageSpeed1 += st.AvSpeed1;
            AverageSpeed2 += st.AvSpeed2;
            TotalTime += st.TimeTaken;
        }
        
        AverageDistance = TotalDistance/N;
        AverageSpeed1 = AverageSpeed1/N;
        AverageSpeed2 = AverageSpeed2/N;
        AverageTime = TotalTime/N;
        
        //WRITE the output string
        
        DecimalFormat form = new DecimalFormat("0.00");
        
        String TheOutput="";
        TimeStamper Now = new TimeStamper();
        TheOutput += ("Run on " + Now.ReturnGuiTime() + "\n");
        TheOutput += ("Data Folder: " + FileNameField.getText()+ "\n\n");
        
        TheOutput += ("**Average Data**\n");
        TheOutput += ("Number of Vehicles: " + Integer.toString(N) + "\n");
        TheOutput += ("Total Distance: " +form.format(TotalDistance/1000) + " km\n");
        TheOutput += ("Average Distance: " +form.format(AverageDistance/1000) + " km\n");
        TheOutput += ("Average Speed 1: " +form.format(AverageSpeed1*3.6) + " kph\n");
        TheOutput += ("Average Speed 2: " +form.format(AverageSpeed2*3.6) + " kph\n");
        TheOutput += ("Total Time: " +form.format(TotalTime/60) + " min\n");
        TheOutput += ("Average Time: " +form.format(AverageTime/60) + " min\n\n");
        
        TheOutput +=("**Individual vehicle data**\n");
        TheOutput +=("Car, Distance (m), Av Speed 1 (m/s), Total Time (s), Start, End\n");
        
        int i=1;
        for(JourneyStats st : TheStats)
        {
            TheOutput += (form.format(i)+", "+form.format(st.DistanceTravelled)+", "+form.format(st.AvSpeed1)+", "+form.format(st.TimeTaken)+", "+st.JourneyStart.ReturnGuiTime()+", "+st.JourneyEnd.ReturnGuiTime()+"\n");
            i++;
        }
                
        TheOutput += "********************\n********************\n\n";
       
        
        //OutputTextArea.append(TheOutput);
        
        File OutputFile = new File(FileNameField.getText() + File.separator + "RunData_" + Now.ReturnGuiTime()+".txt");
        
        try{
            Writer ToGoOut = new BufferedWriter(new FileWriter(OutputFile));
            ToGoOut.write(TheOutput);
            ToGoOut.close();
            TheOutput += ("Output Data also written to: " + OutputFile.getPath());
        }
        catch(Exception e)
        {
            TheOutput += ("Output file failed to write: " + e.toString());
        }
        TheOutput += "\n\n";
        
        OutputTextArea.append(TheOutput);
    }
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton BrowseFileButton;
    private javax.swing.JFormattedTextField DateField;
    private javax.swing.JPanel DateTimePanel;
    private javax.swing.JFormattedTextField EndTimeField;
    private javax.swing.JPanel FileLoadPanel;
    private javax.swing.JFormattedTextField FileNameField;
    private javax.swing.JScrollPane OutputScrollPane;
    private javax.swing.JTextArea OutputTextArea;
    private javax.swing.JButton RunButton;
    private javax.swing.JFormattedTextField StartTimeField;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JPanel jPanel1;
    // End of variables declaration//GEN-END:variables
}
